<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Dashboard - $5.3M Value Capture Platform</title>

    <!-- Styles -->
    <link rel="stylesheet" href="bi_dashboard.css">

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Icon mappings for Font Awesome */
        .icon-refresh::before { content: '\f021'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .icon-download::before { content: '\f019'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .icon-close::before { content: '\f00d'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .icon-error::before { content: '\f071'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .icon-trending-up::before { content: '\f201'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .icon-users::before { content: '\f0c0'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .icon-gauge::before { content: '\f624'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .icon-settings::before { content: '\f013'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
    </style>
</head>
<body>
    <!-- BI Dashboard Container -->
    <div id="biDashboard"></div>

    <!-- JavaScript -->
    <script src="bi_dashboard_realtime.js"></script>

    <script>
        /**
         * BI Dashboard Demo Application
         * ============================
         *
         * Demonstrates the $5.3M value capture BI dashboard integration
         * with real-time streaming, multi-tier access, and predictive analytics.
         */

        class BIDashboardDemo {
            constructor() {
                this.dashboard = null;
                this.authToken = 'demo-token-12345'; // In production, get from auth system
                this.userTier = this.getUserTierFromURL() || 'executive'; // Default to executive for demo
                this.init();
            }

            getUserTierFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('tier');
            }

            async init() {
                try {
                    // Set auth token
                    localStorage.setItem('authToken', this.authToken);

                    // Initialize dashboard with demo configuration
                    this.dashboard = new BIDashboardRealtime('biDashboard', {
                        dashboardId: 'demo-dashboard-001',
                        userTier: this.userTier,
                        refreshInterval: 30000, // 30 seconds
                        apiBase: '/api/v1/bi'
                    });

                    // For demo purposes, simulate data if API is not available
                    this.setupDemoMode();

                } catch (error) {
                    console.error('Failed to initialize BI dashboard demo:', error);
                    this.showDemoError(error);
                }
            }

            setupDemoMode() {
                // Check if API is available
                fetch('/api/v1/bi/health')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('API not available');
                        }
                        console.log('Connected to live BI API');
                    })
                    .catch(() => {
                        console.log('API not available, running in demo mode');
                        this.runDemoMode();
                    });
            }

            runDemoMode() {
                // Override API calls with demo data
                const originalFetch = window.fetch;

                window.fetch = (url, options) => {
                    if (url.includes('/api/v1/bi/')) {
                        return this.handleDemoAPICall(url, options);
                    }
                    return originalFetch(url, options);
                };

                // Show demo banner
                this.showDemoBanner();
            }

            async handleDemoAPICall(url, options) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 200));

                if (url.includes('/dashboards/demo-dashboard-001/data')) {
                    return new Response(JSON.stringify({
                        dashboard_id: 'demo-dashboard-001',
                        data: this.generateDemoData(),
                        last_updated: new Date().toISOString(),
                        cache_status: 'demo',
                        user_tier: this.userTier
                    }), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    });
                }

                if (url.includes('/dashboards/demo-dashboard-001')) {
                    return new Response(JSON.stringify({
                        dashboard_id: 'demo-dashboard-001',
                        name: `BI Dashboard Demo - ${this.userTier.toUpperCase()}`,
                        tier: this.userTier,
                        refresh_interval_seconds: 30,
                        created_at: new Date().toISOString(),
                        last_updated: new Date().toISOString()
                    }), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    });
                }

                if (url.includes('/alerts')) {
                    return new Response(JSON.stringify(this.generateDemoAlerts()), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    });
                }

                if (url.includes('/value-metrics')) {
                    return new Response(JSON.stringify({
                        estimated_annual_value: 5300000,
                        current_month_savings: 441667,
                        roi_percentage: 285,
                        decision_speed_improvement: 0.75,
                        alert_prevention_value: 850000,
                        efficiency_gains: {
                            data_access_time_reduction: 0.85,
                            report_generation_automation: 0.95,
                            insight_delivery_speed: 0.80
                        },
                        business_impact: {
                            improved_customer_retention: 0.12,
                            operational_efficiency_gain: 0.18,
                            revenue_optimization: 0.08
                        }
                    }), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    });
                }

                // Default response
                return new Response('{}', {
                    status: 200,
                    headers: { 'Content-Type': 'application/json' }
                });
            }

            generateDemoData() {
                const baseData = {
                    system_status: {
                        overall_health: 94.5,
                        api_health: 98.2,
                        database_health: 96.8,
                        data_freshness_minutes: 2,
                        active_users: 127,
                        last_updated: new Date().toISOString()
                    }
                };

                if (this.userTier === 'executive') {
                    return {
                        ...baseData,
                        executive_summary: {
                            timeframe: "2024-08-01 to 2024-08-31",
                            revenue: {
                                total: 2847000,
                                growth_rate: "12.5%",
                                per_customer: 1847
                            },
                            customers: {
                                total: 1542,
                                new: 127,
                                retention_rate: "94.2%"
                            },
                            performance: {
                                overall_score: "87.3/100",
                                operational_efficiency: "92.1%",
                                gross_margin: "34.7%"
                            }
                        },
                        predictions: {
                            revenue_outlook: {
                                predicted_growth: 0.15,
                                confidence: 0.87
                            },
                            customer_outlook: {
                                predicted_new_customers: 145,
                                predicted_churn: 23,
                                churn_risk_level: "low"
                            },
                            business_outlook: {
                                market_trend: "positive",
                                opportunity_score: 78
                            }
                        },
                        performance_score: 87.3,
                        insights: this.generateDemoInsights(),
                        alerts: this.generateDemoAlerts()
                    };
                } else if (this.userTier === 'manager') {
                    return {
                        ...baseData,
                        summary: {
                            revenue: {
                                total: 2847000,
                                growth_rate: "12.5%",
                                per_customer: 1847
                            },
                            customers: {
                                total: 1542,
                                retention_rate: "94.2%"
                            }
                        },
                        operational_metrics: {
                            efficiency: 0.921,
                            total_orders: 1847,
                            customer_satisfaction: 4.3
                        },
                        insights: this.generateDemoInsights().slice(0, 5),
                        performance_score: 87.3
                    };
                } else if (this.userTier === 'analyst') {
                    return {
                        ...baseData,
                        detailed_metrics: {
                            revenue_metrics: {
                                total_revenue: 2847000,
                                growth_rate: 0.125,
                                average_order_value: 1542,
                                revenue_per_customer: 1847
                            },
                            customer_metrics: {
                                total_customers: 1542,
                                new_customers: 127,
                                retention_rate: 0.942,
                                acquisition_cost: 245
                            },
                            operational_metrics: {
                                total_orders: 1847,
                                conversion_rate: 0.067,
                                operational_efficiency: 0.921
                            }
                        },
                        raw_data: this.generateDemoRawData(),
                        data_quality: {
                            quality_score: 0.97,
                            completeness: 0.94
                        }
                    };
                } else { // operator
                    return {
                        ...baseData,
                        operational_status: {
                            efficiency: 0.921,
                            total_orders: 1847,
                            system_health: 94.5
                        }
                    };
                }
            }

            generateDemoInsights() {
                return [
                    {
                        type: 'revenue_opportunity',
                        segment: 'premium_customers',
                        action: 'Focus marketing efforts on premium_customers segment',
                        potential_impact: 425000,
                        priority: 'high'
                    },
                    {
                        type: 'retention_risk',
                        action: 'Implement retention campaigns for at-risk customers',
                        affected_customers: 23,
                        priority: 'high'
                    },
                    {
                        type: 'upselling_opportunity',
                        action: 'Promote premium_services to high_value_segment',
                        confidence: 0.84,
                        priority: 'medium'
                    }
                ];
            }

            generateDemoAlerts() {
                const alerts = [];

                if (Math.random() > 0.7) { // 30% chance of critical alert
                    alerts.push({
                        id: 'alert-001',
                        metric_name: 'customer_retention_rate',
                        current_value: 0.89,
                        threshold_value: 0.90,
                        severity: 'warning',
                        message: 'Customer retention rate (89%) below target threshold',
                        recommendation: 'Launch customer retention campaigns and analyze churn causes',
                        business_impact: 'Medium - Customer lifetime value at risk',
                        estimated_revenue_impact: 125000,
                        created_at: new Date().toISOString(),
                        acknowledged: false
                    });
                }

                if (Math.random() > 0.8) { // 20% chance of revenue alert
                    alerts.push({
                        id: 'alert-002',
                        metric_name: 'revenue_growth_rate',
                        current_value: 0.08,
                        threshold_value: 0.10,
                        severity: 'info',
                        message: 'Revenue growth rate (8%) slightly below monthly target',
                        recommendation: 'Review marketing effectiveness and sales pipeline',
                        business_impact: 'Low - Monitor for trends',
                        estimated_revenue_impact: 75000,
                        created_at: new Date().toISOString(),
                        acknowledged: false
                    });
                }

                return alerts;
            }

            generateDemoRawData() {
                const data = [];
                const today = new Date();

                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);

                    data.push({
                        date: date.toISOString().split('T')[0],
                        revenue: Math.round(85000 + Math.random() * 30000),
                        orders: Math.round(45 + Math.random() * 20),
                        customers: Math.round(35 + Math.random() * 15),
                        efficiency: (0.85 + Math.random() * 0.15).toFixed(3)
                    });
                }

                return data;
            }

            showDemoBanner() {
                const banner = document.createElement('div');
                banner.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                        color: white;
                        padding: 12px 24px;
                        text-align: center;
                        font-weight: 600;
                        position: sticky;
                        top: 0;
                        z-index: 1000;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    ">
                        <i class="fas fa-flask"></i>
                        DEMO MODE - Simulated data for ${this.userTier.toUpperCase()} tier
                        <span style="margin-left: 16px; font-size: 12px; opacity: 0.9;">
                            Try different tiers:
                            <a href="?tier=executive" style="color: white; text-decoration: underline;">Executive</a> |
                            <a href="?tier=manager" style="color: white; text-decoration: underline;">Manager</a> |
                            <a href="?tier=analyst" style="color: white; text-decoration: underline;">Analyst</a> |
                            <a href="?tier=operator" style="color: white; text-decoration: underline;">Operator</a>
                        </span>
                    </div>
                `;
                document.body.prepend(banner);
            }

            showDemoError(error) {
                document.getElementById('biDashboard').innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        min-height: 100vh;
                        padding: 32px;
                        text-align: center;
                        background-color: #f5f5f5;
                    ">
                        <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #f44336; margin-bottom: 24px;"></i>
                        <h1 style="color: #f44336; margin-bottom: 16px;">Demo Initialization Failed</h1>
                        <p style="color: #666; margin-bottom: 24px; max-width: 500px;">
                            The BI dashboard demo could not be initialized. This might be due to missing dependencies or configuration issues.
                        </p>
                        <pre style="
                            background-color: #fff;
                            padding: 16px;
                            border-radius: 8px;
                            border-left: 4px solid #f44336;
                            text-align: left;
                            overflow-x: auto;
                            max-width: 600px;
                            font-size: 12px;
                        ">${error.message}</pre>
                        <button onclick="location.reload()" style="
                            background-color: #1976d2;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                            margin-top: 24px;
                        ">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Initialize demo when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new BIDashboardDemo();
        });

        // Add performance tracking
        window.addEventListener('load', () => {
            const loadTime = performance.now();
            console.log(`BI Dashboard loaded in ${loadTime.toFixed(2)}ms`);
        });
    </script>
</body>
</html>